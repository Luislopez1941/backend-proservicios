// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserType {
  client
  worker
}

enum JobUrgency {
  normal
  urgent
}

enum JobStatus {
  open
  active
  in_progress
  completed
  cancelled
  canceled
  accepted
  finished_work
  completed_work
  payment_completed
  confirmed_payment
  payment_pending
  payment_failed
  payment_refunded
  payment_expired
  payment_cancelled
}

enum ChatType {
  private
  group
}

enum MessageType {
  normal
  proposal
}

enum ProposalStatus {
  active
  canceled
  accepted
  finished_work
  completed_work
  payment_completed
  confirmed_payment
  payment_pending
  payment_failed
  payment_refunded
  payment_expired
  payment_cancelled
}

enum ReservationStatus {
  pending
  confirmed
  cancelled
  completed
  rejected
}

enum NotificationType {
  proposal_received
  proposal_accepted
  proposal_rejected
  proposal_cancelled
  job_assigned
  job_completed
  job_cancelled
  message_received
  reservation_created
  reservation_confirmed
  reservation_cancelled
  review_received
  appointment_confirmed
  appointment_cancelled
  payment_received
  payment_failed
  system
}

// Models
model User {
  id               Int     @id @default(autoincrement())
  first_name       String  @db.VarChar(255)
  second_name      String? @db.VarChar(255)
  first_surname    String  @db.VarChar(255)
  second_last_name String? @db.VarChar(255)
  country          String? @db.VarChar(255)
  email            String  @unique @db.VarChar(255)
  password         String  @db.VarChar(255)
  profilePhoto     String? @db.Text
  background       String? @db.Text
  workPhotos       Json?
  phone            String  @db.VarChar(255)
  description      String? @default("") @db.Text
  gender           String? @db.VarChar(50)
  age              Int?
  professions      Json?
  starts           Json?
  verified         Boolean @default(false)

  calendar Json?
  calendar_enabled Boolean @default(false)

  birthdate       DateTime?
  completed_works Int       @default(0)
  paid_jobs       Int       @default(0)
  finished_works  Int       @default(0)


  //////////////////////Facturacion///////////////////////////
  income_month           Float @default(0.0)
  income_year            Float @default(0.0)
  income_total           Float @default(0.0)
  income_month_last      Float @default(0.0)
  income_year_last       Float @default(0.0)
  income_total_last      Float @default(0.0)
  income_month_last_year Float @default(0.0)
  income_year_last_year  Float @default(0.0)
  income_total_last_year Float @default(0.0)

  //////////////////////Raiting///////////////////////////
  reviewsCount Int   @default(0)
  rating       Float @default(0.0)

  dni       String?   @db.VarChar(50)
  type_user UserType?

  // Google Maps Location Data
  location_address  String? @db.Text
  location_lat      Float?
  location_lng      Float?
  location_place_id String? @db.VarChar(255)
  location_bounds   Json?
  
  // Structured Location Data
  location_street     String? @db.VarChar(255)  // Calle y número
  location_colony     String? @db.VarChar(255)  // Colonia/Barrio
  location_city       String? @db.VarChar(255)  // Ciudad/Municipio
  location_state       String? @db.VarChar(255)  // Estado
  location_postal_code String? @db.VarChar(10)   // Código postal
  location_country    String? @db.VarChar(255)  // País

  // Relaciones inversas
  jobs             Job[]
  sentMessages     Message[]     @relation("MessageSender")
  receivedMessages Message[]     @relation("MessageReceiver")
  user1Chats       Chat[]        @relation("ChatIssuer")
  user2Chats       Chat[]        @relation("ChatReceiver")
  proposals        JobProposal[]
  reviews          Review[]      @relation("ReviewUser")
  issuedReservations Reservation[] @relation("ReservationIssuer")
  receivedReservations Reservation[] @relation("ReservationReceiver")
  receivedNotifications Notification[] @relation("NotificationReceiver")
  sentNotifications     Notification[] @relation("NotificationSender")

  @@map("users")
}



model Job {
  id          Int        @id @default(autoincrement())
  id_user     Int
  receiver_id Int?
  issuer_id   Int?
  title       String     @db.VarChar(255)
  description String     @db.Text
  category    String     @db.VarChar(255)
  budget      Json
  location    String     @db.VarChar(255)
  urgency     JobUrgency @default(normal)
  status      JobStatus  @default(active)
  professions Json
  images      Json?

  price          String   @db.VarChar(255)
  proposalsCount Int      @default(0)
  postedTime     DateTime @default(now())
  viewsCount     Int      @default(0)
  requirements   Json?
  timeline       String?  @db.VarChar(255)
  workType       String?  @db.VarChar(255)
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now())

  //////////////////////Rating///////////////////////////
  rating_status_reviwer Boolean      @default(false)
  rating_status_receiver Boolean      @default(false)
  review_status_reviewer Boolean      @default(false)
  review_status_receiver Boolean      @default(false)
  rating_reviewer        Int?         // Calificación de 1 a 5
  rating_receiver        Int?         // Calificación de 1 a 5

  // Google Maps Location Data
  location_address  String? @db.Text
  location_lat      Float?
  location_lng      Float?
  location_place_id String? @db.VarChar(255)
  location_bounds   Json?
  
  // Structured Location Data
  location_street     String? @db.VarChar(255)  // Calle y número
  location_colony     String? @db.VarChar(255)  // Colonia/Barrio
  location_city       String? @db.VarChar(255)  // Ciudad/Municipio
  location_state       String? @db.VarChar(255)  // Estado
  location_postal_code String? @db.VarChar(10)   // Código postal
  location_country    String? @db.VarChar(255)  // País

  // Relaciones
  user User @relation(fields: [id_user], references: [id], onDelete: Cascade)

  // Relaciones inversas
  notifications Notification[]

  @@map("jobs")
}

model Profession {
  id   Int    @id @default(autoincrement())
  name String @unique

  @@map("professions")
}

model Chat {
  id           Int      @id @default(autoincrement())
  chat_type    ChatType
  created_at   DateTime @default(now())
  issuer_id    Int
  receiver_id  Int
  message_text Json
  updated_at   DateTime @default(now())

  // Relaciones
  issuer   User @relation("ChatIssuer", fields: [issuer_id], references: [id])
  receiver User @relation("ChatReceiver", fields: [receiver_id], references: [id])

  // Relaciones inversas
  messages Message[]

  @@map("chats")
}

model Message {
  id                  Int         @id @default(autoincrement())
  issuer_id           Int
  receiver_id         Int
  chat_id             Int
  message             String?     @db.Text
  title               String?
  type_message        MessageType
  created_at          DateTime    @default(now())
  updated_at          DateTime    @default(now())
  unread_count        Int         @default(0)
  last_message_sender String
  message_status      String
  is_online           Boolean     @default(true)

  // Relaciones
  issuer   User @relation("MessageSender", fields: [issuer_id], references: [id])
  receiver User @relation("MessageReceiver", fields: [receiver_id], references: [id])
  chat     Chat @relation(fields: [chat_id], references: [id], onDelete: Cascade)

  // Relaciones inversas
  proposal JobProposal?

  @@map("messages")
}

model JobProposal {
  id          Int            @id @default(autoincrement())
  message_id  Int            @unique
  user_id     Int
  issuer_id   Int
  receiver_id Int
  title       String
  description String?        @db.Text
  images      Json?
  status      ProposalStatus @default(active)
  created_at  DateTime       @default(now())
  updated_at  DateTime       @default(now())
  rating_status_reviwer Boolean      @default(false)
  rating_status_receiver Boolean      @default(false)
  review_status_reviewer Boolean      @default(false)
  review_status_receiver Boolean      @default(false)
  rating_reviewer        Int?         // Calificación de 1 a 5
  rating_receiver        Int?         // Calificación de 1 a 5

  //////////////////////Precio Total///////////////////////////
  price_total            Int?    // Precio total en centavos (ej: 150000 = $1500.00)
  currency               String? @default("MXN") @db.VarChar(3) // Código de moneda (MXN, USD, EUR, etc.)
  accepts_payment_methods Json?   // Métodos de pago aceptados

  // Relaciones
  message Message @relation(fields: [message_id], references: [id])
  user    User    @relation(fields: [user_id], references: [id])
  
  // Relaciones inversas
  notifications Notification[]
}

model Review {
  id          Int      @id @default(autoincrement())
  user_id     Int      // Usuario que recibe la reseña
  user_review_id Int?      // Usuario que da la reseña
  comment     String?  @db.Text // Comentario opcional
  job_id      Int?     // ID del trabajo al que se le da la reseña (opcional)
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())

  // Relaciones
  user User @relation("ReviewUser", fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, job_id], name: "unique_review_per_user_job")
  @@map("reviews")
}

model Location {
  id          Int    @id @default(autoincrement())
  id_location Int
  name        String @db.VarChar(255)
  type        String @db.VarChar(50)

  @@unique([id_location, type], name: "id_location_type")
  @@map("locations")
}

model Reservation {
  id          Int              @id @default(autoincrement())
  issuer_id   Int              // Usuario que hace la reservación (cliente)
  receiver_id Int              // Usuario que recibe la reservación (trabajador)
  date        DateTime         // Fecha de la reservación
  start_time  String           @db.VarChar(10) // Hora de inicio (ej: "09:00")
  end_time    String           @db.VarChar(10)  // Hora de fin (ej: "10:00")
  status      ReservationStatus @default(pending)
  notes       String?          @db.Text        // Notas adicionales de la reservación
  created_at  DateTime         @default(now())
  updated_at  DateTime         @default(now())

  // Relaciones
  issuer   User @relation("ReservationIssuer", fields: [issuer_id], references: [id], onDelete: Cascade)
  receiver User @relation("ReservationReceiver", fields: [receiver_id], references: [id], onDelete: Cascade)

  @@map("reservations")
}

model Notification {
  id          Int             @id @default(autoincrement())
  user_id     Int             // Usuario que recibe la notificación
  from_user_id Int?           // ID del usuario que envía/crea la notificación (opcional)
  type        NotificationType // Tipo de notificación
  title       String          @db.VarChar(255) // Título de la notificación
  message     String          @db.Text // Mensaje de la notificación
  is_read     Boolean         @default(false) // Si la notificación ha sido leída
  read_at     DateTime?       // Fecha en que se leyó la notificación
  
  // Relaciones opcionales
  job_id      Int?            // ID del trabajo relacionado (opcional)
  proposal_id Int?            // ID de la propuesta relacionada (opcional)
  
  // Datos adicionales en JSON (para información extra)
  metadata    Json?           // Datos adicionales de la notificación
  
  created_at  DateTime        @default(now())
  updated_at  DateTime        @default(now())

  // Relaciones
  user      User         @relation("NotificationReceiver", fields: [user_id], references: [id], onDelete: Cascade)
  fromUser  User?        @relation("NotificationSender", fields: [from_user_id], references: [id], onDelete: SetNull)
  job       Job?         @relation(fields: [job_id], references: [id], onDelete: SetNull)
  proposal  JobProposal? @relation(fields: [proposal_id], references: [id], onDelete: SetNull)

  @@index([user_id])
  @@index([from_user_id])
  @@index([is_read])
  @@index([created_at])
  @@map("notifications")
}
